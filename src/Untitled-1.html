<!DOCTYPE html>
<html>
<head>
  <title>Zone & Task Map</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    #map { height: 100vh; }

    .info.legend {
      background: white;
      padding: 10px;
      line-height: 18px;
      color: #333;
      border-radius: 5px;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
    }
    .info.legend i {
      width: 18px;
      height: 18px;
      float: left;
      margin-right: 8px;
      opacity: 0.7;
      background: #ccc;
    }

    #search-container, #filter-container {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      background: white;
      padding: 10px 15px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      display: flex;
      gap: 10px;
    }

    #search-container {
      top: 20px;
    }

    #filter-container {
      top: 80px;
    }

    #coordInput, #timeslotFilter, #typeFilter, #filter-container button {
      padding: 6px 12px;
      font-size: 14px;
      border-radius: 4px;
    }

    #filter-container button, #search-container button {
      background: #007bff;
      color: white;
      border: none;
      cursor: pointer;
    }

    #filter-container button:hover, #search-container button:hover {
      background: #0056b3;
    }
  </style>
</head>
<body>

  <div id="search-container">
    <input type="text" id="coordInput" placeholder="Enter lat,lng">
    <button onclick="searchCoordinates()">Go</button>
  </div>

  <div id="filter-container">
    <select id="timeslotFilter">
      <option value="">All Timeslots</option>
      <option value="9am to 12pm">9am to 12pm</option>
      <option value="12pm to 3pm">12pm to 3pm</option>
      <option value="3pm to 6pm">3pm to 6pm</option>
      <option value="6pm to 9pm">6pm to 9pm</option>
    </select>

    <select id="typeFilter">
      <option value="">All Types</option>
      <option value="DROP">DROP</option>
      <option value="PICK">PICK</option>
    </select>

    <button onclick="applyFilters()">Filter</button>
    <button onclick="resetFilters()">Reset</button>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([12.95, 77.64], 12);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19
    }).addTo(map);

    // === Polygons ===
    const taskPolygons = {"type":"FeatureCollection", "features": [
                {"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[77.6018244,12.937827],[77.6004511,12.9175825],[77.6006227,12.9083798],[77.6021677,12.9057027],[77.6270586,12.9035274],[77.6386463,12.8733228],[77.6457697,12.8729048],[77.657271,12.8901409],[77.6742655,12.8857902],[77.6852518,12.903862],[77.6960665,12.9080452],[77.7080828,12.9359867],[77.7080828,12.9416749],[77.6934915,12.9450209],[77.6588159,12.9232712],[77.6467997,12.9259482],[77.6327234,12.9393327],[77.6267153,12.950709],[77.6196772,12.952382],[77.6152137,12.9427625],[77.6018244,12.937827]]]},"properties":{"name":"Polygon 1","styleUrl":"#poly-558B2F-1200-77-nodesc","fill-opacity":0.30196078431372547,"fill":"#558b2f","stroke-opacity":1,"stroke":"#558b2f","stroke-width":1.2}},
                {"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[77.6621763,12.9976916],[77.6497308,12.9920882],[77.6502673,12.9889311],[77.6313631,12.9815502],[77.6255266,12.9822193],[77.621235,12.9793756],[77.6208917,12.9730191],[77.6354829,12.9608073],[77.6411478,12.9482604],[77.6629488,12.94341],[77.6793424,12.9443299],[77.6909296,12.9465874],[77.707924,12.9444126],[77.7221719,12.9472566],[77.7199403,12.9664951],[77.7098123,12.9676661],[77.699341,12.9947645],[77.6900713,12.9996151],[77.6785699,13.0011205],[77.6659957,12.99581],[77.6621763,12.9976916]]]},"properties":{"name":"SHL","styleUrl":"#poly-558B2F-1200-77-nodesc","fill-opacity":0.30196078431372547,"fill":"#558b2f","stroke-opacity":1,"stroke":"#558b2f","stroke-width":1.2}},
                {"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[77.599122,12.9166199],[77.5941438,12.9172892],[77.5944872,12.8863336],[77.6351709,12.8789706],[77.6264162,12.9023975],[77.5989504,12.9065807],[77.599122,12.9166199]]]},"properties":{"name":"Polygon 7","styleUrl":"#poly-FFD600-1200-77-nodesc","fill-opacity":0.30196078431372547,"fill":"#ffd600","stroke-opacity":1,"stroke":"#ffd600","stroke-width":1.2}},
                {"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[77.6293558,12.9829946],[77.6489252,12.9891836],[77.6485819,12.993198],[77.6636881,13.0000558],[77.667293,12.9972124],[77.6770777,13.0028993],[77.6980203,12.998885],[77.71038,12.9692778],[77.7172464,12.9691105],[77.7057451,13.0172832],[77.6926988,13.0375196],[77.654075,13.0214644],[77.6212877,13.0010594],[77.6293558,12.9829946]]]},"properties":{"name":"Polygon 8","styleUrl":"#poly-FFD600-1200-77-nodesc","fill-opacity":0.30196078431372547,"fill":"#ffd600","stroke-opacity":1,"stroke":"#ffd600","stroke-width":1.2}},
                {"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[77.6576784,12.8891017],[77.6470354,12.8718655],[77.6576784,12.8534566],[77.6436022,12.8450885],[77.6518419,12.8243343],[77.680681,12.8390632],[77.7064302,12.8628286],[77.6961306,12.8850856],[77.6738146,12.8839143],[77.6576784,12.8891017]]]},"properties":{"name":"Polygon 10","styleUrl":"#poly-FFD600-1200-77-nodesc","fill-opacity":0.30196078431372547,"fill":"#ffd600","stroke-opacity":1,"stroke":"#ffd600","stroke-width":1.2}}
                ]};
    const polygonLayer = L.geoJSON(taskPolygons, {
      style: f => ({
        color: f.properties.fill,
        fillColor: f.properties.fill,
        weight: 1,
        fillOpacity: 0.3
      }),
      onEachFeature: (feature, layer) => {
        layer.bindPopup(`<strong>${feature.properties.name}</strong>`);
      }
    }).addTo(map);

    // === Zone Markers ===
    const zoneMarkers = {"type":"FeatureCollection", "features": [
{"type":"Feature","geometry":{"type":"Point","coordinates":[77.6565372,12.9818309,0]},"properties":{"name":"Point 4","styleUrl":"#icon-1899-0288D1-nodesc","icon-opacity":1,"icon-color":"#0288d1","icon-scale":1,"icon-offset":[32,64],"icon-offset-units":["pixels","insetPixels"],"icon":"https://www.gstatic.com/mapspro/images/stock/503-wht-blank_maps.png"}},
{"type":"Feature","geometry":{"type":"Point","coordinates":[77.6383613,12.9118132,0]},"properties":{"name":"BBD - TCL - HSR","styleUrl":"#icon-1899-0288D1-nodesc","icon-opacity":1,"icon-color":"#0288d1","icon-scale":1,"icon-offset":[32,64],"icon-offset-units":["pixels","insetPixels"],"icon":"https://www.gstatic.com/mapspro/images/stock/503-wht-blank_maps.png"}}
]};
    const markerLayer = L.geoJSON(zoneMarkers, {
      pointToLayer: (feature, latlng) => L.marker(latlng),
      onEachFeature: (feature, layer) => {
        layer.bindPopup(`<strong>${feature.properties.name}</strong>`);
      }
    }).addTo(map);

    // Fit bounds
    const allFeatures = L.featureGroup([polygonLayer, markerLayer]);
    map.fitBounds(allFeatures.getBounds());

    // === Task Markers from Google Sheets ===
    const sheetUrl = "https://script.google.com/macros/s/AKfycbxIrYO2Nt9y3EFCMpNO9buENRDBq6O7kcz4I4wWEWIXKieMPJvTwZBUJrj3FVH8tJU3/exec";
    let taskMarkers = [];

    fetch(sheetUrl)
      .then(res => res.json())
      .then(data => {
        taskMarkers = data.map(row => {
          const lat = parseFloat(row["Latitude"]);
          const lng = parseFloat(row["Longitude"]);
          const type = row["Task Type"];
          const time = row["Time slot"];
          const color = type === "PICK" ? "#0288d1" : "#ff5722";

          const marker = L.circleMarker([lat, lng], {
            radius: 6,
            fillColor: color,
            color: "#000",
            weight: 1,
            opacity: 1,
            fillOpacity: 0.8
          }).bindPopup(`<strong>${row["Name"]}</strong><br>Type: ${type}<br>Time: ${time}`);

          marker.taskData = row;
          marker.addTo(map);
          return marker;
        });
      })
      .catch(err => {
        console.error("Error loading tasks:", err);
        alert("Failed to load tasks.");
      });

    // === Search Marker ===
    let searchMarker = null;
    function searchCoordinates() {
      const input = document.getElementById("coordInput").value.trim();
      const parts = input.split(",");
      if (parts.length !== 2) {
        alert("Please enter: lat,lng");
        return;
      }
      const lat = parseFloat(parts[0]);
      const lng = parseFloat(parts[1]);
      if (isNaN(lat) || isNaN(lng)) {
        alert("Invalid coordinates.");
        return;
      }

      if (searchMarker) map.removeLayer(searchMarker);
      searchMarker = L.marker([lat, lng]).addTo(map)
        .bindPopup(`Searched:<br>Lat: ${lat}<br>Lng: ${lng}`).openPopup();
      map.setView([lat, lng], 16);
    }

    // === Filtering Logic ===
    function applyFilters() {
      const selectedTimeslot = document.getElementById("timeslotFilter").value;
      const selectedType = document.getElementById("typeFilter").value;

      taskMarkers.forEach(marker => {
        const data = marker.taskData;
        const timeslotMatch = !selectedTimeslot || data["Time slot"] === selectedTimeslot;
        const typeMatch = !selectedType || data["Task Type"] === selectedType;

        if (timeslotMatch && typeMatch) {
          marker.addTo(map);
        } else {
          map.removeLayer(marker);
        }
      });
    }

    function resetFilters() {
      document.getElementById("timeslotFilter").value = "";
      document.getElementById("typeFilter").value = "";
      applyFilters();
    }

    // === Legend ===
    const legend = L.control({ position: 'bottomright' });
    legend.onAdd = function () {
      const div = L.DomUtil.create('div', 'info legend');
      div.innerHTML += '<i style="background: #558b2f"></i> Green Zone<br>';
      div.innerHTML += '<i style="background: #ffd600"></i> Yellow Zone';
      return div;
    };
    legend.addTo(map);

 
  </script>
</body>
</html>
